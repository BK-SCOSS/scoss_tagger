<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.7.2/build/styles/default.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.7.2/build/highlight.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="hlcode.css">
    <title>Hệ thống điểm danh bằng source code</title>
</head>

<body>
    <div class="wrap-login">
        <div class="login-title">
            <span>Hệ thống điểm danh bằng source code</span>
        </div>
        <div class="wrap-hint">
            <button onclick="getRandomHints('hints.txt')">Gợi ý</button>
            <span id="hint-text"></span>
        </div>
        <div class="wrap-sample-io">
            <div class="sample-input">
                <label for="sample-input-text"><b>Input mẫu:</b></label>
                <textarea id="sample-input-text" readonly></textarea>
            </div>
            <div class="sample-output">  
                <label for="sample-output-text"><b>Output mẫu:</b></label>
                <textarea id="sample-output-text" readonly></textarea>
            </div>
            <div class="output">
                <label for="output-text" style="margin-left: 5%;"><b>Output của bạn:</b></label>
                <textarea id="output-text" readonly></textarea>
            </div>
        </div>
        <div class="vl"></div>
        <div class="wrap-source-code">
            <label for="source-code"><b>Source code mẫu:</b></label>
            <pre id="source-code">
                <code id="source-code-text"></code>
            </pre>
        </div>
        <div class="wrap-input-source-code">
            <form id="source-code-new"> 
                <label for="input-source-code-text"><b>Nhập source code mới:</b></label>
                <textarea id="input-source-code-text" placeholder="Nhập source code mới tại đây..."></textarea> 
            </form>
        </div>
        <div class="wrap-btn">
            <p id="run-result"></p>
            <button onclick="compileCode()" class="compile-btn" type="submit" value="Submit">Biên dịch</button>
            <button onclick="runCode()" class="run-btn" type="submit" value="Submit">Chạy</button>
            <button onclick="runCode(true)" class="submit-btn" type="submit" value="Submit">Nộp</button>
        </div>
        <script language="javascript">
            function getRandomNumber(l, r) {
                return l + Math.floor(Math.random() * (r - l + 1));
            }
            function getRandomSubarray(arr, size) {
                var shuffled = arr.slice(0), i = arr.length, temp, index;
                while (i--) {
                    index = Math.floor((i + 1) * Math.random());
                    temp = shuffled[index];
                    shuffled[index] = shuffled[i];
                    shuffled[i] = temp;
                }
                return shuffled.slice(0, size);
            }
            function getRandomHints(file) {
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", file, false);
                rawFile.onreadystatechange = function () {
                    if (rawFile.readyState === 4) {
                        if (rawFile.status === 200 || rawFile.status == 0) {
                            var allText = rawFile.responseText;
                            var split = allText.split('\n');
                            var randomTextArr = getRandomSubarray(split, getRandomNumber(4, 5));
                            var randomText = "";
                            for (var i = 0; i < randomTextArr.length; ++i) {
                                randomText += "(" + (i + 1 - '0') + ")" + " " + randomTextArr[i] + "\n";
                            }
                            document.getElementById("hint-text").innerText = randomText;
                        }
                    }
                }
                rawFile.send(null);
            }
            getRandomHints("hints.txt");

            function getSampleCode(file) {
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", file, false);
                rawFile.onreadystatechange = function () {
                    if (rawFile.readyState === 4) {
                        if (rawFile.status === 200 || rawFile.status == 0) {
                            var allText = rawFile.responseText;
                            html = hljs.highlight(allText, {language: 'c++'}).value;
                            document.getElementById("source-code-text").innerHTML = html;
                        }
                    }
                }
                rawFile.send(null);
            }
            getSampleCode("sample-code.txt");

            var idSrc;
            function getSourceCode() {
                $(document).ready(function (e) {
                    $.get("/api/get_code", function (res) {
                        res = JSON.parse(res)
                        if (res['errCode'] == 200) {
                            allText = res.src
                            idSrc = res.id
                            html = hljs.highlight(allText, {language: 'c++'}).value;
                            document.getElementById("source-code-text").innerHTML = html;
                            document.getElementById("sample-input-text").innerText = res.input;
                            document.getElementById("sample-output-text").innerText = res.output;
                        } else {
                            alert("Vui long config mongodb!");
                        }
                    })
                })
            }
            getSourceCode();


            function runCode(submit=false) {
                document.getElementById('run-result').innerText = '';
                $(document).ready(function () {
                    var val = $.trim($("#input-source-code-text").val());
                    
                    url_api = '/api/code/run'
                    if (submit==true){
                        url_api = '/api/code/submit'
                    }

                    if (val != "") {
                        $.ajax({
                            url: url_api,
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            success: function (data) {
                                console.log(data)
                                data = JSON.parse(data)
                                console.log(data)

                                if (data.save_label == true && submit == true) {
                                    alert("Nop source thanh cong!");
                                    $("#input-source-code-text").val('');
                                    getSourceCode();
                                    getRandomHints("hints.txt");
                                } else {
                                    document.getElementById("output-text").innerText = data.output;
                                    if (data.save_label == true) {
                                        document.getElementById('run-result').innerText = "Source cho ket qua chinh xac!";
                                    } else if (data.rescompil == "") {
                                        document.getElementById('run-result').innerText = "Source cho ket qua khong chinh xac!";
                                    } else {
                                        document.getElementById('run-result').innerText = data.rescompil;
                                    }
                                }
                                

                            },
                            data: JSON.stringify({ "id": idSrc, "label": val })
                        });
                    } else {
                        alert("Vui long nhap source code!");
                    }
                });
            }

            function compileCode() {
                document.getElementById('run-result').innerText = '';
                $(document).ready(function () {
                    var val = $.trim($("#input-source-code-text").val());
                    if (val != "") {
                        $.ajax({
                            url: '/api/compile',
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            success: function (data) {
                                console.log(data)
                                data = JSON.parse(data)
                                console.log(data)


                                if (data.errCode == 200) {
                                    document.getElementById('run-result').innerText = data.rescompil
                                } else {
                                    document.getElementById('run-result').innerText = "Bien dich loi: " + data.rescompil
                                }
                            },
                            data: JSON.stringify({ "id": idSrc, "label": val })
                        });
                    } else {
                        alert("Vui long nhap source code!");
                    }
                });
            }

        </script>
    </div>
</body>

</html>